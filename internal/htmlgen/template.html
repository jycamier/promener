<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Info.Title}} - Metrics Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900" x-data="metricsApp()">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{.Info.Title}}</h1>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Version {{.Info.Version}}</p>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Search -->
                    <input
                        type="text"
                        x-model="search"
                        placeholder="Search metrics..."
                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                    >
                    <!-- Dark mode toggle -->
                    <button
                        @click="toggleDarkMode()"
                        class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"
                    >
                        <span x-show="darkMode">üåô</span>
                        <span x-show="!darkMode">‚òÄÔ∏è</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Sidebar -->
            <nav class="lg:col-span-2">
                <div class="sticky top-24 bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 overflow-y-auto" style="max-height: calc(100vh - 7rem);">
                    <div class="space-y-2" x-data="{ openNamespaces: {} }">
                        <template x-for="(subsystems, namespace) in groupedMetrics" :key="namespace">
                            <div>
                                <button
                                    @click="openNamespaces[namespace] = !openNamespaces[namespace]"
                                    class="w-full flex items-center justify-between text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wide py-2 px-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10"
                                    :class="{ 'mb-2': openNamespaces[namespace] }"
                                >
                                    <span x-text="namespace"></span>
                                    <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': openNamespaces[namespace] }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div x-show="openNamespaces[namespace]" x-collapse>
                                    <template x-for="(metrics, subsystem) in subsystems" :key="namespace + subsystem">
                                        <div class="ml-2 mb-3" x-data="{ open: true }">
                                            <button
                                                @click="open = !open"
                                                class="w-full flex items-center justify-between text-sm font-semibold text-gray-700 dark:text-gray-300 py-1 px-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700"
                                            >
                                                <span x-text="subsystem"></span>
                                                <svg class="w-3 h-3 transition-transform" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </button>
                                            <ul class="ml-2 space-y-1 mt-1" x-show="open" x-collapse>
                                                <template x-for="metric in metrics" :key="metric.fullName">
                                                    <li>
                                                        <a
                                                            :href="'#' + metric.fullName"
                                                            class="block px-2 py-1 rounded text-xs hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400 truncate"
                                                            :title="metric.fullName"
                                                            x-text="metric.name"
                                                        ></a>
                                                    </li>
                                                </template>
                                            </ul>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="lg:col-span-3">
                <template x-for="metric in filteredMetrics" :key="metric.fullName">
                    <div
                        :id="metric.fullName"
                        class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6"
                    >
                        <!-- Metric header -->
                        <div class="mb-4">
                            <div class="flex items-start justify-between">
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white" x-text="metric.fullName"></h3>
                                    <span
                                        class="inline-block px-2 py-1 text-xs font-semibold rounded mt-2"
                                        :class="{
                                            'bg-blue-100 text-blue-800': metric.type === 'counter',
                                            'bg-green-100 text-green-800': metric.type === 'gauge',
                                            'bg-purple-100 text-purple-800': metric.type === 'histogram',
                                            'bg-yellow-100 text-yellow-800': metric.type === 'summary'
                                        }"
                                        x-text="metric.type.toUpperCase()"
                                    ></span>
                                </div>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 mt-2" x-text="metric.help"></p>
                        </div>

                        <!-- Labels -->
                        <div class="mb-4" x-show="metric.labels.length > 0">
                            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Labels</h4>
                            <div class="space-y-2">
                                <template x-for="label in metric.labels" :key="label.name">
                                    <div>
                                        <code class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-sm font-mono text-gray-800 dark:text-gray-200" x-text="label.name"></code>
                                        <p class="ml-2 mt-1 text-sm text-gray-600 dark:text-gray-400" x-show="label.description" x-text="label.description"></p>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Constant Labels -->
                        <div class="mb-4" x-show="metric.constLabels && metric.constLabels.length > 0">
                            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Constant Labels</h4>
                            <div class="space-y-2">
                                <template x-for="label in metric.constLabels" :key="label.name">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <code class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-sm font-mono text-gray-800 dark:text-gray-200" x-text="label.name"></code>
                                            <span class="text-sm text-gray-500 dark:text-gray-500">=</span>
                                            <code class="px-2 py-1 bg-blue-50 dark:bg-blue-900 rounded text-sm font-mono text-blue-800 dark:text-blue-200" x-text="label.value"></code>
                                        </div>
                                        <p class="ml-2 mt-1 text-sm text-gray-600 dark:text-gray-400" x-show="label.description" x-text="label.description"></p>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Examples tabs -->
                        <div x-show="metric.examples && (metric.examples.promql || metric.examples.alerts)" x-data="{ activeTab: 'promql' }">
                            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Examples</h4>

                            <!-- Tabs -->
                            <div class="border-b border-gray-200 dark:border-gray-700 mb-4">
                                <nav class="flex space-x-4">
                                    <button
                                        @click="activeTab = 'promql'"
                                        :class="activeTab === 'promql' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                        class="py-2 px-1 border-b-2 font-medium text-sm"
                                        x-show="metric.examples.promql && metric.examples.promql.length > 0"
                                    >
                                        PromQL
                                    </button>
                                    <button
                                        @click="activeTab = 'alerts'"
                                        :class="activeTab === 'alerts' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                        class="py-2 px-1 border-b-2 font-medium text-sm"
                                        x-show="metric.examples.alerts && metric.examples.alerts.length > 0"
                                    >
                                        Alerts
                                    </button>
                                </nav>
                            </div>

                            <!-- PromQL examples -->
                            <div x-show="activeTab === 'promql' && metric.examples.promql" class="space-y-4">
                                <template x-for="example in metric.examples.promql" :key="example.query">
                                    <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2" x-show="example.description" x-text="example.description"></p>
                                        <div class="relative">
                                            <pre class="bg-gray-900 text-gray-100 p-4 rounded overflow-x-auto text-sm"><code x-text="example.query"></code></pre>
                                            <button
                                                @click="copyToClipboard(example.query)"
                                                class="absolute top-2 right-2 px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs rounded"
                                            >
                                                Copy
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <!-- Alert examples -->
                            <div x-show="activeTab === 'alerts' && metric.examples.alerts" class="space-y-4">
                                <template x-for="example in metric.examples.alerts" :key="example.name">
                                    <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                                        <div class="flex items-center justify-between mb-2">
                                            <h5 class="font-semibold text-gray-900 dark:text-white" x-text="example.name"></h5>
                                            <span
                                                class="px-2 py-1 text-xs font-semibold rounded"
                                                :class="{
                                                    'bg-red-100 text-red-800': example.severity === 'critical',
                                                    'bg-orange-100 text-orange-800': example.severity === 'warning',
                                                    'bg-blue-100 text-blue-800': example.severity === 'info'
                                                }"
                                                x-show="example.severity"
                                                x-text="example.severity"
                                            ></span>
                                        </div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2" x-show="example.description" x-text="example.description"></p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2" x-show="example.for">
                                            For: <span x-text="example.for"></span>
                                        </p>
                                        <div class="relative">
                                            <pre class="bg-gray-900 text-gray-100 p-4 rounded overflow-x-auto text-sm"><code x-text="example.expr"></code></pre>
                                            <button
                                                @click="copyToClipboard(example.expr)"
                                                class="absolute top-2 right-2 px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs rounded"
                                            >
                                                Copy
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <div x-show="filteredMetrics.length === 0" class="text-center py-12">
                    <p class="text-gray-500 dark:text-gray-400">No metrics found matching your search.</p>
                </div>
            </main>
        </div>
    </div>

    <script>
        function metricsApp() {
            // Initialize dark mode from localStorage or system preference
            const savedMode = localStorage.getItem('darkMode');
            const initialDarkMode = savedMode !== null
                ? savedMode === 'true'
                : window.matchMedia('(prefers-color-scheme: dark)').matches;

            return {
                search: '',
                darkMode: initialDarkMode,
                metrics: {{.MetricsJSON}},

                get filteredMetrics() {
                    if (!this.search) return this.metrics;
                    const query = this.search.toLowerCase();
                    return this.metrics.filter(m =>
                        m.fullName.toLowerCase().includes(query) ||
                        m.help.toLowerCase().includes(query) ||
                        m.type.toLowerCase().includes(query)
                    );
                },

                get groupedMetrics() {
                    const grouped = {};
                    this.filteredMetrics.forEach(metric => {
                        if (!grouped[metric.namespace]) {
                            grouped[metric.namespace] = {};
                        }
                        if (!grouped[metric.namespace][metric.subsystem]) {
                            grouped[metric.namespace][metric.subsystem] = [];
                        }
                        grouped[metric.namespace][metric.subsystem].push(metric);
                    });
                    return grouped;
                },

                copyToClipboard(text) {
                    navigator.clipboard.writeText(text).then(() => {
                        alert('Copied to clipboard!');
                    });
                },

                toggleDarkMode() {
                    this.darkMode = !this.darkMode;
                    document.documentElement.classList.toggle('dark', this.darkMode);
                    localStorage.setItem('darkMode', this.darkMode);
                }
            }
        }

        // Apply dark mode immediately on page load
        (function() {
            const savedMode = localStorage.getItem('darkMode');
            const shouldBeDark = savedMode !== null
                ? savedMode === 'true'
                : window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (shouldBeDark) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</body>
</html>
